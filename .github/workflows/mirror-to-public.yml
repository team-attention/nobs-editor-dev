name: Mirror to Public

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  mirror-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private
        uses: actions/checkout@v4
        with:
          path: private

      - name: Checkout public
        uses: actions/checkout@v4
        with:
          repository: team-attention/nobs-editor
          token: ${{ secrets.MIRROR_TOKEN }}
          path: public

      - name: Sync files (exclude private-only)
        run: |
          cd public
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd ..

          rsync -av \
            --exclude='.spets' \
            --exclude='.git' \
            --exclude='.github/workflows/mirror-to-public.yml' \
            private/ public/

      - name: Commit and push
        run: |
          cd public

          ORIGINAL_MSG=$(cd ../private && git log -1 --pretty=%B)
          ORIGINAL_AUTHOR=$(cd ../private && git log -1 --pretty="%an")
          ORIGINAL_EMAIL=$(cd ../private && git log -1 --pretty="%ae")

          git config user.name "$ORIGINAL_AUTHOR"
          git config user.email "$ORIGINAL_EMAIL"
          git add -A

          if git diff --staged --quiet; then
            echo "No changes to sync"
          else
            git commit -m "$ORIGINAL_MSG"
            git push
          fi
