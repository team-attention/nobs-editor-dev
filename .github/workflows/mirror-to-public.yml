name: Mirror to Public

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  mirror-code:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private
        uses: actions/checkout@v4
        with:
          path: private

      - name: Checkout public
        uses: actions/checkout@v4
        with:
          repository: team-attention/nobs-editor
          token: ${{ secrets.MIRROR_TOKEN }}
          path: public

      - name: Sync files (exclude private-only)
        run: |
          cd public
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd ..

          rsync -av \
            --exclude='.spets' \
            --exclude='.git' \
            --exclude='.github/workflows/mirror-to-public.yml' \
            --exclude='.github/workflows/spets.yml' \
            private/ public/

      - name: Commit and push
        run: |
          cd public

          ORIGINAL_MSG=$(cd ../private && git log -1 --pretty=%B)
          ORIGINAL_AUTHOR=$(cd ../private && git log -1 --pretty="%an")
          ORIGINAL_EMAIL=$(cd ../private && git log -1 --pretty="%ae")

          git config user.name "$ORIGINAL_AUTHOR"
          git config user.email "$ORIGINAL_EMAIL"
          git add -A

          if git diff --staged --quiet; then
            echo "No changes to sync"
          else
            git commit -m "$ORIGINAL_MSG"
            git push
          fi

  mirror-tag:
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest
    steps:
      - name: Create tag on public repo
        env:
          GH_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          TAG_NAME="${{ github.ref_name }}"

          PUBLIC_SHA=$(gh api repos/team-attention/nobs-editor/git/refs/heads/main --jq '.object.sha')

          gh api -X DELETE "repos/team-attention/nobs-editor/git/refs/tags/${TAG_NAME}" 2>/dev/null || true

          gh api repos/team-attention/nobs-editor/git/refs \
            -f ref="refs/tags/${TAG_NAME}" \
            -f sha="${PUBLIC_SHA}"

          echo "Created tag ${TAG_NAME} on public repo at ${PUBLIC_SHA}"
